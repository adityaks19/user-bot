const User = require('../models/User');
const Pass = require('../models/Pass');
const { Markup } = require('telegraf');
const { getLocalizedMessage } = require('../utils/messageHandler');
const { updateState, updateSessionData } = require('../utils/sessionManager');
const { generateQRCode } = require('../utils/qrGenerator');

// Pass types with their details
const passTypes = {
  daily_ac: {
    name: 'Daily Pass (AC)',
    validityDays: 1,
    fare: 60
  },
  daily_nonac: {
    name: 'Daily Pass (Non-AC)',
    validityDays: 1,
    fare: 40
  },
  monthly_ac: {
    name: 'Monthly Pass (AC)',
    validityDays: 30,
    fare: 800
  },
  monthly_nonac: {
    name: 'Monthly Pass (Non-AC)',
    validityDays: 30,
    fare: 600
  },
  student: {
    name: 'Student Pass',
    validityDays: 30,
    fare: 300,
    requiresDocuments: true
  },
  senior: {
    name: 'Senior Citizen Pass',
    validityDays: 30,
    fare: 300,
    requiresDocuments: true
  }
};

/**
 * Start pass purchase flow
 * @param {Object} ctx - Telegram context
 */
const startPassPurchase = async (ctx) => {
  try {
    const { id: telegramId } = ctx.from;
    const user = await User.findOne({ telegramId: telegramId.toString() });
    const language = user?.language || 'english';
    
    // Clear any existing session data for pass purchase
    await updateSessionData(telegramId, { passPurchase: {} });
    
    // Create bus type selection buttons based on language
    let keyboard;
    
    if (language === 'english') {
      keyboard = [
        [Markup.button.callback('üöå AC Bus', 'pass_bus_ac')],
        [Markup.button.callback('üöå Non-AC Bus', 'pass_bus_nonac')],
        [Markup.button.callback('üè† Back to Main Menu', 'back_to_menu')]
      ];
    } else if (language === 'hindi') {
      keyboard = [
        [Markup.button.callback('üöå ‡§è‡§∏‡•Ä ‡§¨‡§∏', 'pass_bus_ac')],
        [Markup.button.callback('üöå ‡§®‡•â‡§®-‡§è‡§∏‡•Ä ‡§¨‡§∏', 'pass_bus_nonac')],
        [Markup.button.callback('üè† ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Ç ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Ç', 'back_to_menu')]
      ];
    } else if (language === 'punjabi') {
      keyboard = [
        [Markup.button.callback('üöå ‡®è‡®∏‡©Ä ‡®¨‡©±‡®∏', 'pass_bus_ac')],
        [Markup.button.callback('üöå ‡®®‡®æ‡®®-‡®è‡®∏‡©Ä ‡®¨‡©±‡®∏', 'pass_bus_nonac')],
        [Markup.button.callback('üè† ‡®Æ‡©Å‡©±‡®ñ ‡®Æ‡©á‡®®‡©Ç ‡®§‡©á ‡®µ‡®æ‡®™‡®∏ ‡®ú‡®æ‡®ì', 'back_to_menu')]
      ];
    }
    
    // Ask for bus type with inline keyboard
    const busTypeText = {
      english: 'Please select bus type for your pass:',
      hindi: '‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•á ‡§™‡§æ‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡§∏ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç:',
      punjabi: '‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®Ü‡®™‡®£‡©á ‡®™‡®æ‡®∏ ‡®≤‡®à ‡®¨‡©±‡®∏ ‡®¶‡©Ä ‡®ï‡®ø‡®∏‡®Æ ‡®ö‡©Å‡®£‡©ã:'
    };
    
    await ctx.reply(
      busTypeText[language] || busTypeText.english,
      Markup.inlineKeyboard(keyboard)
    );
    
    // Update user state
    await updateState(telegramId, 'PASS_SELECTING_BUS_TYPE');
  } catch (error) {
    console.error('Error in startPassPurchase:', error);
    await ctx.reply('Sorry, something went wrong. Please try again.');
  }
};

/**
 * Show pass types based on bus type
 * @param {Object} ctx - Telegram context
 * @param {string} busType - Selected bus type (ac or nonac)
 */
const showPassTypes = async (ctx, busType) => {
  try {
    const { id: telegramId } = ctx.from;
    const user = await User.findOne({ telegramId: telegramId.toString() });
    const language = user?.language || 'english';
    
    // Save bus type to session data
    await updateSessionData(telegramId, { 
      passPurchase: { 
        busType
      } 
    });
    
    // Create pass type buttons based on language and bus type
    let keyboard;
    
    if (language === 'english') {
      keyboard = [
        [Markup.button.callback('üéüÔ∏è Daily Pass', `pass_type_daily_${busType}`)],
        [Markup.button.callback('üéüÔ∏è Monthly Pass', `pass_type_monthly_${busType}`)],
        [Markup.button.callback('üéì Student Pass', 'pass_type_student')],
        [Markup.button.callback('üëµ Senior Citizen Pass', 'pass_type_senior')],
        [Markup.button.callback('‚¨ÖÔ∏è Back', 'pass_back_to_bus_type')],
        [Markup.button.callback('üè† Back to Main Menu', 'back_to_menu')]
      ];
    } else if (language === 'hindi') {
      keyboard = [
        [Markup.button.callback('üéüÔ∏è ‡§¶‡•à‡§®‡§ø‡§ï ‡§™‡§æ‡§∏', `pass_type_daily_${busType}`)],
        [Markup.button.callback('üéüÔ∏è ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§™‡§æ‡§∏', `pass_type_monthly_${busType}`)],
        [Markup.button.callback('üéì ‡§õ‡§æ‡§§‡•ç‡§∞ ‡§™‡§æ‡§∏', 'pass_type_student')],
        [Markup.button.callback('üëµ ‡§µ‡§∞‡§ø‡§∑‡•ç‡§† ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï ‡§™‡§æ‡§∏', 'pass_type_senior')],
        [Markup.button.callback('‚¨ÖÔ∏è ‡§µ‡§æ‡§™‡§∏', 'pass_back_to_bus_type')],
        [Markup.button.callback('üè† ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Ç ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Ç', 'back_to_menu')]
      ];
    } else if (language === 'punjabi') {
      keyboard = [
        [Markup.button.callback('üéüÔ∏è ‡®∞‡©ã‡®ú‡®º‡®æ‡®®‡®æ ‡®™‡®æ‡®∏', `pass_type_daily_${busType}`)],
        [Markup.button.callback('üéüÔ∏è ‡®Æ‡®π‡©Ä‡®®‡®æ‡®µ‡®æ‡®∞ ‡®™‡®æ‡®∏', `pass_type_monthly_${busType}`)],
        [Markup.button.callback('üéì ‡®µ‡®ø‡®¶‡®ø‡®Ü‡®∞‡®•‡©Ä ‡®™‡®æ‡®∏', 'pass_type_student')],
        [Markup.button.callback('üëµ ‡®∏‡©Ä‡®®‡©Ä‡®Ö‡®∞ ‡®∏‡®ø‡®ü‡©Ä‡®ú‡®º‡®® ‡®™‡®æ‡®∏', 'pass_type_senior')],
        [Markup.button.callback('‚¨ÖÔ∏è ‡®µ‡®æ‡®™‡®∏', 'pass_back_to_bus_type')],
        [Markup.button.callback('üè† ‡®Æ‡©Å‡©±‡®ñ ‡®Æ‡©á‡®®‡©Ç ‡®§‡©á ‡®µ‡®æ‡®™‡®∏ ‡®ú‡®æ‡®ì', 'back_to_menu')]
      ];
    }
    
    // Add prices to pass types
    const passTypeText = {
      english: `Please select pass type for ${busType === 'ac' ? 'AC' : 'Non-AC'} bus:`,
      hindi: `‡§ï‡•É‡§™‡§Ø‡§æ ${busType === 'ac' ? '‡§è‡§∏‡•Ä' : '‡§®‡•â‡§®-‡§è‡§∏‡•Ä'} ‡§¨‡§∏ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§æ‡§∏ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç:`,
      punjabi: `‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ${busType === 'ac' ? '‡®è‡®∏‡©Ä' : '‡®®‡®æ‡®®-‡®è‡®∏‡©Ä'} ‡®¨‡©±‡®∏ ‡®≤‡®à ‡®™‡®æ‡®∏ ‡®¶‡©Ä ‡®ï‡®ø‡®∏‡®Æ ‡®ö‡©Å‡®£‡©ã:`
    };
    
    // Update keyboard with prices
    if (language === 'english') {
      keyboard[0][0] = Markup.button.callback(`üéüÔ∏è Daily Pass (‚Çπ${passTypes[`daily_${busType}`].fare})`, `pass_type_daily_${busType}`);
      keyboard[1][0] = Markup.button.callback(`üéüÔ∏è Monthly Pass (‚Çπ${passTypes[`monthly_${busType}`].fare})`, `pass_type_monthly_${busType}`);
      keyboard[2][0] = Markup.button.callback(`üéì Student Pass (‚Çπ${passTypes.student.fare})`, 'pass_type_student');
      keyboard[3][0] = Markup.button.callback(`üëµ Senior Citizen Pass (‚Çπ${passTypes.senior.fare})`, 'pass_type_senior');
    } else if (language === 'hindi') {
      keyboard[0][0] = Markup.button.callback(`üéüÔ∏è ‡§¶‡•à‡§®‡§ø‡§ï ‡§™‡§æ‡§∏ (‚Çπ${passTypes[`daily_${busType}`].fare})`, `pass_type_daily_${busType}`);
      keyboard[1][0] = Markup.button.callback(`üéüÔ∏è ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§™‡§æ‡§∏ (‚Çπ${passTypes[`monthly_${busType}`].fare})`, `pass_type_monthly_${busType}`);
      keyboard[2][0] = Markup.button.callback(`üéì ‡§õ‡§æ‡§§‡•ç‡§∞ ‡§™‡§æ‡§∏ (‚Çπ${passTypes.student.fare})`, 'pass_type_student');
      keyboard[3][0] = Markup.button.callback(`üëµ ‡§µ‡§∞‡§ø‡§∑‡•ç‡§† ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï ‡§™‡§æ‡§∏ (‚Çπ${passTypes.senior.fare})`, 'pass_type_senior');
    } else if (language === 'punjabi') {
      keyboard[0][0] = Markup.button.callback(`üéüÔ∏è ‡®∞‡©ã‡®ú‡®º‡®æ‡®®‡®æ ‡®™‡®æ‡®∏ (‚Çπ${passTypes[`daily_${busType}`].fare})`, `pass_type_daily_${busType}`);
      keyboard[1][0] = Markup.button.callback(`üéüÔ∏è ‡®Æ‡®π‡©Ä‡®®‡®æ‡®µ‡®æ‡®∞ ‡®™‡®æ‡®∏ (‚Çπ${passTypes[`monthly_${busType}`].fare})`, `pass_type_monthly_${busType}`);
      keyboard[2][0] = Markup.button.callback(`üéì ‡®µ‡®ø‡®¶‡®ø‡®Ü‡®∞‡®•‡©Ä ‡®™‡®æ‡®∏ (‚Çπ${passTypes.student.fare})`, 'pass_type_student');
      keyboard[3][0] = Markup.button.callback(`üëµ ‡®∏‡©Ä‡®®‡©Ä‡®Ö‡®∞ ‡®∏‡®ø‡®ü‡©Ä‡®ú‡®º‡®® ‡®™‡®æ‡®∏ (‚Çπ${passTypes.senior.fare})`, 'pass_type_senior');
    }
    
    await ctx.editMessageText(
      passTypeText[language] || passTypeText.english,
      Markup.inlineKeyboard(keyboard)
    );
    
    // Update user state
    await updateState(telegramId, 'PASS_SELECTING_TYPE');
  } catch (error) {
    console.error('Error in showPassTypes:', error);
    await ctx.reply('Sorry, something went wrong. Please try again.');
  }
};

/**
 * Handle pass type selection
 * @param {Object} ctx - Telegram context
 * @param {string} passType - Selected pass type
 */
const handlePassTypeSelection = async (ctx, passType) => {
  try {
    const { id: telegramId } = ctx.from;
    const user = await User.findOne({ telegramId: telegramId.toString() });
    const language = user?.language || 'english';
    
    // Get pass details based on pass type
    let passDetails;
    if (passType === 'student' || passType === 'senior') {
      passDetails = passTypes[passType];
    } else {
      // For daily_ac, daily_nonac, monthly_ac, monthly_nonac
      passDetails = passTypes[passType];
    }
    
    // Save pass type and details to session data
    await updateSessionData(telegramId, { 
      passPurchase: { 
        ...user.sessionData.passPurchase,
        passType,
        passDetails,
        documentStep: 1 // Initialize document step for multi-document uploads
      } 
    });
    
    // Check if documents are required
    if (passDetails.requiresDocuments) {
      if (passType === 'senior') {
        // For senior citizens, only ask for Aadhar card
        const documentText = {
          english: `Please upload the required document for ${passDetails.name}:\n\n` +
                  'Upload your Aadhar Card (PDF only)',
          hindi: `‡§ï‡•É‡§™‡§Ø‡§æ ${passDetails.name} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç:\n\n` +
                '‡§Ö‡§™‡§®‡§æ ‡§Ü‡§ß‡§æ‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§° ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (‡§ï‡•á‡§µ‡§≤ PDF)',
          punjabi: `‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ${passDetails.name} ‡®≤‡®à ‡®≤‡©ã‡©ú‡©Ä‡®Ç‡®¶‡©á ‡®¶‡®∏‡®§‡®æ‡®µ‡©á‡®ú‡®º ‡®Ö‡®™‡®≤‡©ã‡®° ‡®ï‡®∞‡©ã:\n\n` +
                  '‡®Ü‡®™‡®£‡®æ ‡®Ü‡®ß‡®æ‡®∞ ‡®ï‡®æ‡®∞‡®° ‡®Ö‡®™‡®≤‡©ã‡®° ‡®ï‡®∞‡©ã (‡®∏‡®ø‡®∞‡®´ PDF)'
        };
        
        await ctx.editMessageText(
          documentText[language] || documentText.english,
          Markup.inlineKeyboard([
            [Markup.button.callback('‚¨ÖÔ∏è Back', 'pass_back_to_types')],
            [Markup.button.callback('üè† Back to Main Menu', 'back_to_menu')]
          ])
        );
        
        // Set document step to 2 for senior citizens (skip college ID)
        await updateSessionData(telegramId, { 
          passPurchase: { 
            ...user.sessionData.passPurchase,
            documentStep: 2 // Skip to Aadhar card step
          } 
        });
      } else {
        // For students, ask for college ID first
        const documentText = {
          english: `Please upload the required documents for ${passDetails.name}:\n\n` +
                  'Step 1/2: Upload College/School ID Card (PDF only)',
          hindi: `‡§ï‡•É‡§™‡§Ø‡§æ ${passDetails.name} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç:\n\n` +
                '‡§ö‡§∞‡§£ 1/2: ‡§ï‡•â‡§≤‡•á‡§ú/‡§∏‡•ç‡§ï‡•Ç‡§≤ ‡§Ü‡§à‡§°‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§° ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (‡§ï‡•á‡§µ‡§≤ PDF)',
          punjabi: `‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ${passDetails.name} ‡®≤‡®à ‡®≤‡©ã‡©ú‡©Ä‡®Ç‡®¶‡©á ‡®¶‡®∏‡®§‡®æ‡®µ‡©á‡®ú‡®º ‡®Ö‡®™‡®≤‡©ã‡®° ‡®ï‡®∞‡©ã:\n\n` +
                  '‡®ï‡®¶‡®Æ 1/2: ‡®ï‡®æ‡®≤‡®ú/‡®∏‡®ï‡©Ç‡®≤ ‡®Ü‡®à‡®°‡©Ä ‡®ï‡®æ‡®∞‡®° ‡®Ö‡®™‡®≤‡©ã‡®° ‡®ï‡®∞‡©ã (‡®∏‡®ø‡®∞‡®´ PDF)'
        };
        
        await ctx.editMessageText(
          documentText[language] || documentText.english,
          Markup.inlineKeyboard([
            [Markup.button.callback('‚¨ÖÔ∏è Back', 'pass_back_to_types')],
            [Markup.button.callback('üè† Back to Main Menu', 'back_to_menu')]
          ])
        );
      }
      
      // Update user state
      await updateState(telegramId, 'PASS_UPLOADING_DOCUMENT');
    } else {
      // No documents required, show pass summary
      await showPassSummary(ctx);
    }
  } catch (error) {
    console.error('Error in handlePassTypeSelection:', error);
    await ctx.reply('Sorry, something went wrong. Please try again.');
  }
};

/**
 * Handle document upload
 * @param {Object} ctx - Telegram context
 */
const handleDocumentUpload = async (ctx) => {
  try {
    const { id: telegramId } = ctx.from;
    const user = await User.findOne({ telegramId: telegramId.toString() });
    const language = user?.language || 'english';
    
    // Check if a document was uploaded and if it's a PDF
    if (!ctx.message.document || !ctx.message.document.mime_type || !ctx.message.document.mime_type.includes('pdf')) {
      await ctx.reply(
        language === 'english' ? 'Please upload a PDF document only.' : 
        language === 'hindi' ? '‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•á‡§µ‡§≤ PDF ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§' : 
        '‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®∏‡®ø‡®∞‡®´ PDF ‡®¶‡®∏‡®§‡®æ‡®µ‡©á‡®ú‡®º ‡®Ö‡®™‡®≤‡©ã‡®° ‡®ï‡®∞‡©ã‡•§',
        Markup.inlineKeyboard([
          [Markup.button.callback('‚¨ÖÔ∏è Back', 'pass_back_to_types')],
          [Markup.button.callback('üè† Back to Main Menu', 'back_to_menu')]
        ])
      );
      return;
    }
    
    // Get file ID from document
    const fileId = ctx.message.document.file_id;
    const documentStep = user.sessionData.passPurchase.documentStep || 1;
    const passType = user.sessionData.passPurchase.passType;
    
    if (passType === 'senior') {
      // For senior citizens, only need Aadhar card
      await updateSessionData(telegramId, { 
        passPurchase: { 
          ...user.sessionData.passPurchase,
          aadharFileId: fileId,
          documentStep: 3 // Skip to final step
        } 
      });
      
      // Confirm document receipt - specific message for senior citizens
      await ctx.reply(
        language === 'english' ? 'Document received. Thank you!' : 
        language === 'hindi' ? '‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•Å‡§Ü‡•§ ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶!' : 
        '‡®¶‡®∏‡®§‡®æ‡®µ‡©á‡®ú‡®º ‡®™‡©ç‡®∞‡®æ‡®™‡®§ ‡®π‡©ã‡®á‡®Ü‡•§ ‡®ß‡©∞‡®®‡®µ‡®æ‡®¶!',
        Markup.inlineKeyboard([
          [Markup.button.callback('‚úÖ Continue', 'pass_continue')],
          [Markup.button.callback('‚¨ÖÔ∏è Back', 'pass_back_to_types')],
          [Markup.button.callback('üè† Back to Main Menu', 'back_to_menu')]
        ])
      );
      
      // Update user state
      await updateState(telegramId, 'PASS_DOCUMENT_RECEIVED');
    } else if (documentStep === 1) {
      // First document (ID Card) for student pass
      await updateSessionData(telegramId, { 
        passPurchase: { 
          ...user.sessionData.passPurchase,
          idCardFileId: fileId,
          documentStep: 2
        } 
      });
      
      // Ask for second document (Aadhar Card)
      const documentText = {
        english: 'Step 2/2: Please upload your Aadhar Card (PDF only)',
        hindi: '‡§ö‡§∞‡§£ 2/2: ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§Ü‡§ß‡§æ‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§° ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (‡§ï‡•á‡§µ‡§≤ PDF)',
        punjabi: '‡®ï‡®¶‡®Æ 2/2: ‡®ï‡®ø‡®∞‡®™‡®æ ‡®ï‡®∞‡®ï‡©á ‡®Ü‡®™‡®£‡®æ ‡®Ü‡®ß‡®æ‡®∞ ‡®ï‡®æ‡®∞‡®° ‡®Ö‡®™‡®≤‡©ã‡®° ‡®ï‡®∞‡©ã (‡®∏‡®ø‡®∞‡®´ PDF)'
      };
      
      await ctx.reply(
        documentText[language] || documentText.english,
        Markup.inlineKeyboard([
          [Markup.button.callback('‚¨ÖÔ∏è Back', 'pass_back_to_types')],
          [Markup.button.callback('üè† Back to Main Menu', 'back_to_menu')]
        ])
      );
      
      // Keep the same state for second document
      await updateState(telegramId, 'PASS_UPLOADING_DOCUMENT');
    } else {
      // Second document (Aadhar Card) for student pass
      await updateSessionData(telegramId, { 
        passPurchase: { 
          ...user.sessionData.passPurchase,
          aadharFileId: fileId,
          documentStep: 3
        } 
      });
      
      // Confirm documents receipt - specific message for student passes
      await ctx.reply(
        language === 'english' ? 'Both documents received. Thank you!' : 
        language === 'hindi' ? '‡§¶‡•ã‡§®‡•ã‡§Ç ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•Å‡§è‡•§ ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶!' : 
        '‡®¶‡©ã‡®µ‡©á‡®Ç ‡®¶‡®∏‡®§‡®æ‡®µ‡©á‡®ú‡®º ‡®™‡©ç‡®∞‡®æ‡®™‡®§ ‡®π‡©ã‡®è‡•§ ‡®ß‡©∞‡®®‡®µ‡®æ‡®¶!',
        Markup.inlineKeyboard([
          [Markup.button.callback('‚úÖ Continue', 'pass_continue')],
          [Markup.button.callback('‚¨ÖÔ∏è Back', 'pass_back_to_types')],
          [Markup.button.callback('üè† Back to Main Menu', 'back_to_menu')]
        ])
      );
      
      // Update user state
      await updateState(telegramId, 'PASS_DOCUMENT_RECEIVED');
    }
  } catch (error) {
    console.error('Error in handleDocumentUpload:', error);
    await ctx.reply(
      'Sorry, something went wrong. Please try again.',
      Markup.inlineKeyboard([
        [Markup.button.callback('‚¨ÖÔ∏è Back', 'pass_back_to_types')],
        [Markup.button.callback('üè† Back to Main Menu', 'back_to_menu')]
      ])
    );
  }
};
